<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Sarah's a leadership assessment and workshop </title>
  <style>
    :root {
      --bg-page: #f5f7fb;
      --bg-surface: #ffffff;
      --border-subtle: #e2e8f0;
      --border-strong: #cbd5f5;
      --text-strong: #0f172a;
      --text-muted: #64748b;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --accent-strong: #1d4ed8;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(180deg, rgba(229, 236, 249, 0.45) 0%, rgba(255, 255, 255, 0.85) 100%);
      color: var(--text-strong);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .app {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      height: 100vh;
    }

    .topbar {
      background: rgba(255, 255, 255, 0.82);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border-subtle);
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 20px;
      position: sticky;
      top: 0;
      z-index: 40;
    }

    .topbar-leading {
      display: flex;
      align-items: center;
      gap: 14px;
      flex: 0 1 auto;
      min-width: 0;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }

    .brand-mark {
      width: 40px;
      height: 40px;
      border-radius: 14px;
      background: linear-gradient(130deg, #001E60, #001E60);
      color: #fff;
      font-weight: 700;
      font-size: 0.82rem;
      display: grid;
      place-items: center;
      letter-spacing: 0.06em;
      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.28);
      flex-shrink: 0;
    }

    .brand-copy {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .brand-title {
      font-size: 1.24rem;
      font-weight: 600;
      margin: 0;
      white-space: nowrap;
    }

    .brand-subtitle {
      margin: 2px 0 0;
      font-size: 0.74rem;
      color: var(--text-muted);
      letter-spacing: 0.01em;
      white-space: nowrap;
    }

    .dataset-badge {
      background: var(--accent-soft);
      color: var(--accent-strong);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      white-space: nowrap;
      flex: 0 1 260px;
      max-width: 260px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: flex-start;
      flex: 1 1 auto;
      min-width: 0;
    }

    .control-field {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 150px;
      font-size: 0.72rem;
      color: var(--text-muted);
      flex: 0 1 180px;
    }

    .control-field select {
      appearance: none;
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 8px 14px;
      font-size: 0.92rem;
      font-weight: 500;
      color: var(--text-strong);
      background: #fff;
      min-height: 38px;
      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.06);
    }
    .control-field select#layoutSelect {
  min-width: 80px;
  width: 80px;
  padding: 4px 8px;
  line-height: 1.2;
  font-size: 0.85rem;
    }

    
    .control-field select:focus {
      outline: 2px solid rgba(37, 99, 235, 0.35);
      outline-offset: 2px;
    }

    .search {
      position: relative;
      min-width: 180px;
      flex: 1 1 280px;
      max-width: 260px;
    }

    .search input {
      width: 100%;
      border: 1px solid var(--border-subtle);
      border-radius: 14px;
      padding: 8px 14px;
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text-strong);
      background: rgba(255, 255, 255, 0.95);
      box-shadow: inset 0 1px 3px rgba(15, 23, 42, 0.08);
      min-height: 38px;
    }

    .search input:focus {
      outline: 2px solid rgba(37, 99, 235, 0.25);
      outline-offset: 2px;
    }

    .search-results {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      width: 100%;
      background: #fff;
      border: 1px solid var(--border-subtle);
      border-radius: 14px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
      overflow: hidden;
      max-height: 320px;
      overflow-y: auto;
      display: none;
      z-index: 50;
    }

    .search-results.open {
      display: block;
    }

    .search-item {
      display: flex;
      flex-direction: column;
      gap: 3px;
      width: 100%;
      border: none;
      background: transparent;
      text-align: left;
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.15s ease;
      font-family: inherit;
    }

    .search-item:hover {
      background: rgba(219, 234, 254, 0.55);
    }

    .search-name {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .search-title {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .search-empty {
      padding: 14px 18px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .button-row {
      display: flex;
      flex-wrap: nowrap;
      gap: 6px;
      align-items: center;
      flex: 0 0 auto;
      padding: 6px 8px;
      border: 1px dashed rgba(148, 163, 184, 0.55);
      border-radius: 12px;
      background: rgba(148, 163, 184, 0.08);
    }

    .button {
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      background: #fff;
      padding: 8px 12px;
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--text-strong);
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      box-shadow: inset 0 -1px 0 rgba(15, 23, 42, 0.05);
      white-space: nowrap;
    }

    .button:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 16px rgba(15, 23, 42, 0.08);
    }

    .button:active {
      transform: translateY(0);
      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.12);
    }

    .button-primary {
      background: var(--accent);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 12px 20px rgba(37, 99, 235, 0.22);
    }

    .button-primary:hover {
      background: var(--accent-strong);
    }

    .file-button {
      position: relative;
      overflow: hidden;
    }

    .file-button input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .banner {
      margin: 0 24px;
      margin-top: 10px;
      padding: 12px 18px;
      border-radius: 14px;
      font-size: 0.88rem;
      font-weight: 500;
      background: rgba(219, 234, 254, 0.75);
      color: var(--accent-strong);
      border: 1px solid rgba(37, 99, 235, 0.18);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
    }

    .banner--warn {
      background: rgba(254, 249, 195, 0.78);
      color: #854d0e;
      border-color: rgba(217, 180, 85, 0.55);
    }

    .banner--error {
      background: rgba(254, 226, 226, 0.85);
      color: #b91c1c;
      border-color: rgba(248, 113, 113, 0.55);
    }

    .banner--hidden {
      display: none;
    }

    .workspace {
      flex: 1;
      display: flex;
      min-height: 0;
      gap: 10px;
      padding: 8px 14px 16px;
      overflow: hidden;
    }

    .chart-shell {
      flex: 1;
      min-width: 0;
      background: var(--bg-surface);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 20px;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    #chartContainer {
      flex: 1;
      position: relative;
      overflow: hidden;
      cursor: grab;
    }

    #chartContainer:active {
      cursor: grabbing;
    }

    #chartContainer svg {
      width: 100%;
      height: 100%;
      font-family: inherit;
    }

    .links path {
      fill: none;
      stroke: rgba(148, 163, 184, 0.55);
      stroke-width: 1.4px;
      transition: stroke 0.2s ease, stroke-width 0.2s ease, opacity 0.2s ease;
    }

    .links path.is-on-path {
      stroke: var(--accent-strong);
      stroke-width: 2.8px;
      opacity: 1;
    }

    .nodes g.node {
      cursor: pointer;
    }

    .node-card {
      fill: #fff;
      stroke: rgba(148, 163, 184, 0.4);
      stroke-width: 1.2px;
      filter: drop-shadow(0 16px 24px rgba(15, 23, 42, 0.12));
      transition: stroke 0.2s ease, filter 0.2s ease;
    }

    .node-card.has-children {
      stroke: rgba(37, 99, 235, 0.18);
    }

    .node-card.is-on-path {
      stroke: var(--accent-strong);
      filter: drop-shadow(0 20px 30px rgba(37, 99, 235, 0.25));
    }

    .node-card.is-selected {
      stroke: var(--accent);
      filter: drop-shadow(0 22px 42px rgba(37, 99, 235, 0.3));
    }

    .node-card.is-strength-match {
      stroke: var(--accent-strong);
      stroke-width: 1.8px;
      filter: drop-shadow(0 20px 34px rgba(37, 99, 235, 0.25));
    }

    .node-card.is-strength-match.is-selected {
      stroke-width: 2.4px;
    }

    .nodes g.node.has-strength-match .node-name {
      color: var(--accent-strong);
    }

    .node-fo {
      pointer-events: none;
    }

    .node-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .node-name {
      font-size: 1.02rem;
      font-weight: 600;
      line-height: 1.25;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .node-title {
      font-size: 0.86rem;
      color: var(--text-muted);
      line-height: 1.25;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .node-meta {
      font-size: 0.75rem;
      color: rgba(100, 116, 139, 0.9);
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .node-chips {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 2px;
    }

    .chip {
      padding: 3px 10px;
      font-size: 0.7rem;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.14);
      color: rgba(15, 23, 42, 0.8);
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    .chip-tier-1 {
      background: rgba(59, 130, 246, 0.18);
      color: #1d4ed8;
    }

    .chip-tier-2 {
      background: rgba(34, 197, 94, 0.18);
      color: #15803d;
    }

    .chip-tier-3 {
      background: rgba(251, 191, 36, 0.22);
      color: #92400e;
    }

    .chip-tier-4 {
      background: rgba(45, 212, 191, 0.2);
      color: #0f766e;
    }

    .chip-tier-5 {
      background: rgba(248, 113, 113, 0.22);
      color: #b91c1c;
    }

    .chip-tier-6 {
      background: rgba(165, 180, 252, 0.22);
      color: #4338ca;
    }

    .chip-soft {
      background: rgba(226, 232, 240, 0.5);
      color: rgba(51, 65, 85, 0.82);
    }

    .chip-status {
      background: rgba(226, 232, 240, 0.55);
      color: rgba(51, 65, 85, 0.86);
      text-transform: capitalize;
    }

    .chip-status.success {
      background: rgba(187, 247, 208, 0.8);
      color: #166534;
    }

    .chip-status.pending {
      background: rgba(254, 240, 138, 0.8);
      color: #92400e;
    }
    .node-toggle {
      pointer-events: all;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .toggle-circle {
      fill: #fff;
      stroke: rgba(148, 163, 184, 0.6);
      stroke-width: 1.1px;
    }

    .toggle-line {
      stroke: rgba(51, 65, 85, 0.8);
      stroke-width: 1.6px;
      stroke-linecap: round;
      transition: opacity 0.18s ease;
    }

    .node-toggle:not(.collapsed) .vertical {
      opacity: 0;
    }

    .tooltip {
      position: absolute;
      pointer-events: none;
      background: #0f172a;
      color: #f8fafc;
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 0.78rem;
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.18);
      opacity: 0;
      transform: translate(-9999px, -9999px);
      transition: opacity 0.12s ease;
      z-index: 60;
      max-width: 260px;
      line-height: 1.4;
    }

    .tooltip.visible {
      opacity: 0.97;
    }

    .tooltip-name {
      font-weight: 600;
    }

    .tooltip-title {
      color: rgba(148, 163, 184, 0.92);
    }

    .tooltip-meta {
      color: rgba(226, 232, 240, 0.75);
    }

    .detail-panel {
      width: 360px;
      background: var(--bg-surface);
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: var(--shadow-soft);
      padding: 22px 24px;
      margin-left: 0;
      display: flex;
      position: relative;
      flex-direction: column;
      max-height: calc(100vh - 120px);
      overflow-y: auto;
    }

    .detail-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 22px;
    }

    .detail-tabs {
      display: flex;
      gap: 10px;
      align-items: center;
      background: rgba(148, 163, 184, 0.12);
      padding: 6px;
      border-radius: 12px;
      position: sticky;
      top: 0;
      z-index: 10;
      margin-bottom: 18px;
    }

    .detail-tab {
      flex: 1;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 0.82rem;
      font-weight: 600;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    }

    .detail-tab:hover {
      color: var(--text-strong);
      background: rgba(148, 163, 184, 0.16);
    }

    .detail-tab.is-active {
      background: var(--accent-soft);
      color: var(--accent-strong);
      box-shadow: inset 0 0 0 1px rgba(37, 99, 235, 0.2);
    }
    .strength-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: none;
      font: inherit;
      color: inherit;
      cursor: pointer;
    }

    .strength-chip:focus-visible {
      outline: 2px solid rgba(37, 99, 235, 0.55);
      outline-offset: 2px;
    }

    .strength-chip.is-active {
      background: var(--accent-soft);
      color: var(--accent-strong);
      box-shadow: inset 0 0 0 1px rgba(37, 99, 235, 0.2);
    }

    .strength-chip-label {
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }

    .strength-chip-rank {
      font-weight: 600;
      color: rgba(30, 41, 59, 0.85);
    }

    .strength-chip.is-active .strength-chip-rank {
      color: inherit;
    }

    .strength-insight {
      margin-top: 14px;
      padding: 14px;
      border-radius: 12px;
      background: rgba(37, 99, 235, 0.08);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .strength-insight-title {
      font-weight: 600;
      color: rgba(30, 41, 59, 0.92);
    }

    .strength-insight-metrics {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      color: rgba(30, 41, 59, 0.8);
      font-size: 0.76rem;
    }

    .strength-insight-metrics span strong {
      font-size: 0.84rem;
      font-weight: 600;
      color: rgba(30, 41, 59, 0.95);
    }


    .detail-body--hidden {
      display: none;
    }

    .trend-summary {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .summary-card {
      flex: 1 1 140px;
      background: rgba(37, 99, 235, 0.08);
      border-radius: 12px;
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .summary-card.active-strength {
      background: rgba(37, 99, 235, 0.18);
      color: var(--accent-strong);
    }

    .summary-card.active-strength .summary-label {
      color: var(--accent-strong);
    }


    .summary-value {
      font-size: 1.35rem;
      font-weight: 700;
      color: var(--accent-strong);
    }

    .summary-label {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-muted);
    }

    .trend-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 14px;
    }

    .trend-controls-label {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }

    .trend-controls-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .trend-sort-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 999px;
      padding: 6px 12px;
      background: #fff;
      color: var(--text-muted);
      font-size: 0.78rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease;
    }

    .trend-sort-btn:hover {
      border-color: rgba(37, 99, 235, 0.45);
      color: var(--text-strong);
    }

    .trend-sort-btn.is-active {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent-strong);
    }

    .trend-sort-icon {
      font-size: 0.78rem;
      line-height: 1;
    }

    .trend-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .trend-item {
      border: 1px solid rgba(148, 163, 184, 0.32);
      border-radius: 14px;
      padding: 10px 14px;
      background: #fff;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
      cursor: pointer;
      transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
      width: 100%;
    }

    .trend-item:hover {
      transform: translateY(-1px);
      border-color: rgba(37, 99, 235, 0.45);
      box-shadow: 0 10px 18px rgba(15, 23, 42, 0.14);
    }

    .trend-item.is-active {
      border-color: var(--accent);
      background: var(--accent-soft);
      box-shadow: 0 14px 24px rgba(37, 99, 235, 0.22);
    }

    .trend-name {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text-strong);
      text-align: left;
      width: 100%;
    }

    .trend-count {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .trend-count strong {
      color: var(--text-strong);
    }

    .trend-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 2px 12px;
      width: 100%;
      font-size: 0.8rem;
      color: var(--text-muted);
      align-items: baseline;
    }

    .trend-rank {
      font-size: 0.68rem;
      color: var(--text-muted);
      flex-basis: 100%;
      font-weight: 500;
      margin-top: 2px;
    }

    .trend-empty {
      margin-top: 40px;
      text-align: center;
      color: var(--text-muted);
    }

    .trend-empty h3 {
      margin: 0 0 6px;
      font-size: 1rem;
    }

    .detail-empty {
      margin-top: 40px;
      text-align: center;
      color: var(--text-muted);
    }

    .detail-empty h2 {
      margin: 0 0 8px;
      font-size: 1rem;
    }

    .detail-header {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .detail-name {
      font-size: 1.35rem;
      font-weight: 700;
      line-height: 1.2;
    }

    .detail-title {
      font-size: 0.95rem;
      color: var(--text-muted);
    }

    .crumbs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      font-size: 0.76rem;
      color: var(--text-muted);
    }

    .crumb {
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(226, 232, 240, 0.5);
    }

    .crumb.current {
      background: var(--accent-soft);
      color: var(--accent-strong);
      font-weight: 600;
    }

    .crumb-divider {
      color: rgba(148, 163, 184, 0.8);
    }

    .detail-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .section-title {
      font-size: 0.82rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: rgba(100, 116, 139, 0.85);
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px 14px;
      font-size: 0.85rem;
    }

    .info-grid .label {
      display: block;
      font-size: 0.72rem;
      font-weight: 600;
      color: rgba(100, 116, 139, 0.9);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 2px;
    }

    .info-grid .value {
      display: block;
      color: var(--text-strong);
      word-break: break-word;
    }

    .value-link {
      color: var(--accent-strong);
      text-decoration: none;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    @media (max-width: 1200px) {
      .detail-panel {
        width: 320px;
      }
    }

    @media (max-width: 1024px) {
      .workspace {
        flex-direction: column;
      }

      .detail-panel {
        width: 100%;
        margin-left: 0;
        margin-top: 18px;
        max-height: none;
      }
    }

    @media (max-width: 980px) {
      .topbar {
        flex-wrap: wrap;
        gap: 16px;
        align-items: flex-start;
      }

      .topbar-leading {
        width: 100%;
        justify-content: space-between;
        gap: 12px;
      }

      .controls {
        flex-wrap: wrap;
        justify-content: flex-start;
        gap: 12px;
      }

      .search {
        order: 3;
        flex: 1 1 100%;
        width: 100%;
        max-width: none;
      }

      .button-row {
        order: 4;
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
      }

      .brand-subtitle {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .workspace {
        padding: 16px;
      }
    }
  </style>
</head>
<body>
<div id="container">
  <div class="app">
    <header class="topbar">
      <div class="topbar-leading">
        <div class="brand">
          <div class="brand-mark">COH</div>
          <div class="brand-copy">
            <div class="brand-title">Assessment Explorer</div>
            <div class="brand-subtitle">A leadership assessment and workshop</div>
          </div>
        </div>
        <div class="dataset-badge" id="datasetLabel">Loading&hellip;</div>
      </div>
      <div class="controls">
        <label class="control-field">
          <select id="rootSelect"></select>
        </label>
        <div class="search">
          <input id="searchInput" type="search" placeholder="Search by name, title, or email">
          <div id="searchResults" class="search-results"></div>
        </div>
        <label class="control-field">
          <select id="layoutSelect">
            <option value="horizontal" selected>Horizontal</option>
            <option value="vertical">Vertical</option>
          </select>
        </label>        
        <div class="button-row">
          <button id="fitBtn" class="button">Fit</button>
          <button id="expandBtn" class="button">Expand</button>
          <button id="collapseBtn" class="button">Collapse</button>
          <button id="resetBtn" class="button">Reset</button>
          
          <label class="button file-button">
            <input id="fileInput" type="file" accept=".xlsx,.xls">
            <span>Upload Excel</span>
          </label>
        </div>
      </div>
    </header>

    <div id="messageBanner" class="banner banner--hidden"></div>

    <section class="workspace">
      <div class="chart-shell">
        <div id="chartContainer"></div>
        <div id="tooltip" class="tooltip"></div>
      </div>
      <aside class="detail-panel">
        <div id="detailTabs" class="detail-tabs">
          <button type="button" class="detail-tab is-active" data-tab="profile">Profile</button>
          <button type="button" class="detail-tab" data-tab="strengths">Strength Trends</button>
        </div>
        <div id="profileBody" class="detail-body"></div>
        <div id="trendBody" class="detail-body detail-body--hidden"></div>
      </aside>
    </section>
  </div>
</div>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    (() => {
      const CONFIG = { nodeWidth: 240, nodeHeight: 108, horizontalGap: 60, verticalGap: 42 };
      const DEFAULT_WORKBOOK = 'Org Chart_GallupStrengthFinder_PowerBI Test.xlsx';
      const ALL_ROOT_ID = '__all__';
      const ALL_ROOT_LABEL = 'COH - Houston Public Works';

      const els = {
        chart: document.getElementById('chartContainer'),
        tooltip: document.getElementById('tooltip'),
        banner: document.getElementById('messageBanner'),
        rootSelect: document.getElementById('rootSelect'),
        layoutSelect: document.getElementById('layoutSelect'),
        datasetLabel: document.getElementById('datasetLabel'),
        fileInput: document.getElementById('fileInput'),
        searchInput: document.getElementById('searchInput'),
        searchResults: document.getElementById('searchResults'),
        detailTabs: document.getElementById('detailTabs'),
        profileBody: document.getElementById('profileBody'),
        trendBody: document.getElementById('trendBody'),
        fitBtn: document.getElementById('fitBtn'),
        expandBtn: document.getElementById('expandBtn'),
        collapseBtn: document.getElementById('collapseBtn'),
        resetBtn: document.getElementById('resetBtn')
      };

      const state = {
        people: [],
        strengths: [],
        roots: [],
        fullById: new Map(),
        parentById: new Map(),
        nodeById: new Map(),
        selectedId: null,
        activeRootId: ALL_ROOT_ID,
        orientation: 'vertical',
        detailTab: 'profile',
        strengthHighlight: null,
        strengthSummary: [],
        strengthSort: { field: 'count', direction: 'desc' },
        datasetName: 'Not loaded'
      };

      let treeLayout = createTreeLayout(state.orientation);
      let connector = createConnector(state.orientation);

      let svg = null;
      let gRoot = null;
      let gLinks = null;
      let gNodes = null;
      let zoomBehavior = null;
      let d3Root = null;
      let bannerTimeout = null;

      function createTreeLayout(orientation) {
        if (orientation === 'vertical') {
          return d3.tree().nodeSize([CONFIG.nodeWidth + CONFIG.horizontalGap, CONFIG.nodeHeight + CONFIG.verticalGap]);
        }
        return d3.tree().nodeSize([CONFIG.nodeHeight + CONFIG.verticalGap, CONFIG.nodeWidth + CONFIG.horizontalGap]);
      }

      function createConnector(orientation) {
        return orientation === 'vertical'
          ? d3.linkVertical().x(d => d.x).y(d => d.y)
          : d3.linkHorizontal().x(d => d.y).y(d => d.x);
      }

      function projectCoordinates(x, y) {
        if (state.orientation === 'vertical') {
          return { px: y, py: x };
        }
        return { px: x, py: y };
      }

      init();

      function init() {
        wireEvents();
        if (els.layoutSelect) {
          els.layoutSelect.value = state.orientation;
        }
        updateDetailTabUi();
        renderTrendPanel();
        renderDetail(null);
        autoLoadDefault();
      }

      function wireEvents() {
        els.fileInput.addEventListener('change', onFileSelected);
        els.rootSelect.addEventListener('change', () => setActiveRoot(els.rootSelect.value));
        els.layoutSelect.addEventListener('change', () => setOrientation(els.layoutSelect.value));
        els.fitBtn.addEventListener('click', () => fitChart());
        els.expandBtn.addEventListener('click', () => expandAll());
        els.collapseBtn.addEventListener('click', () => collapseAll());
        els.resetBtn.addEventListener('click', () => resetView());
        els.searchInput.addEventListener('input', onSearchInput);
        els.searchInput.addEventListener('keydown', onSearchKeyDown);
        if (els.detailTabs) {
          els.detailTabs.addEventListener('click', onDetailTabClick);
        }
        document.addEventListener('click', event => {
          if (!els.searchResults.contains(event.target) && event.target !== els.searchInput) {
            hideSearchResults();
          }
        });
        window.addEventListener('resize', handleResize);
      }

      async function autoLoadDefault() {
        const url = DEFAULT_WORKBOOK.split(' ').join('%20');
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const buffer = await response.arrayBuffer();
          handleWorkbook(buffer, DEFAULT_WORKBOOK);
          showMessage(`Loaded ${DEFAULT_WORKBOOK}`, 'info', true);
        } catch (error) {
          console.warn('Auto-load failed', error);
          showMessage('Upload the Excel workbook to get started.', 'warn');
        }
      }

      async function onFileSelected(event) {
        const file = event.target.files && event.target.files[0];
        if (!file) {
          return;
        }
        try {
          const buffer = await file.arrayBuffer();
          handleWorkbook(buffer, file.name);
          showMessage(`Loaded ${file.name}`, 'info', true);
        } catch (error) {
          console.error(error);
          showMessage('Could not read the selected file.', 'error');
        } finally {
          event.target.value = '';
        }
      }

      function handleWorkbook(buffer, label) {
        let workbook;
        try {
          workbook = XLSX.read(buffer, { type: 'array' });
        } catch (error) {
          console.error(error);
          showMessage('Unable to parse the workbook. Please verify the file.', 'error');
          return;
        }
        const sheetName = workbook.SheetNames[0];
        if (!sheetName) {
          showMessage('The workbook is empty.', 'warn');
          return;
        }
        const sheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, { defval: '', raw: false });
        ingestRows(rows, label || sheetName);
      }

      function ingestRows(rows, label) {
        const { people, strengths } = transformRows(rows);
        if (!people.length) {
          showMessage('No people records were detected.', 'warn');
          return;
        }
        const { roots, fullMap, parentMap } = buildHierarchy(people);
        state.people = people.slice().sort((a, b) => {
          const aLabel = a.name || a.title || a.id;
          const bLabel = b.name || b.title || b.id;
          return aLabel.localeCompare(bLabel);
        });
        state.strengths = strengths;
        state.roots = roots;
        state.fullById = fullMap;
        state.parentById = parentMap;
        state.strengthHighlight = null;
        state.strengthSort = { field: 'count', direction: 'desc' };
        computeStrengthSummary();
        renderTrendPanel();
        setDetailTab('profile');
        state.datasetName = label;
        updateDatasetLabel();
        populateRootSelector(roots);
      }
      function transformRows(rows) {
        const people = [];
        const strengths = [];
        const usedIds = new Set();

        const KEY_ALIASES = {
          id: ['id', 'leaderid', 'employeeid', 'empid', 'personid', 'leadercode', 'uid', 'uniqueid'],
          name: ['name', 'leadername', 'fullname', 'employeename', 'personname', 'staffname'],
          title: ['title', 'role', 'position', 'jobtitle', 'jobrole', 'jobposition'],
          manager: ['manager', 'managerid', 'managername', 'reportingto', 'reportsto', 'reportingmanager', 'supervisor', 'reportsup', 'boss'],
          email: ['email', 'emailaddress', 'mail'],
          division: ['division', 'department', 'dept', 'org', 'organization', 'organisation', 'function', 'team', 'group', 'businessunit'],
          tier: ['tier', 'level', 'layer', 'band', 'grade'],
          location: ['location', 'office', 'region', 'city', 'country', 'site'],
          status: ['status', 'completed', 'completedassessment', 'completedyesno', 'assessmentstatus', 'assessmentcompleted', 'assessment'],
          phone: ['phone', 'phonenumber', 'mobile', 'contact']
        };

        const strengthRegex = /^(top|strength)(\d{0,2})$/;

        rows.forEach((row, index) => {
          const entries = Object.entries(row || {});
          const hasValue = entries.some(([, value]) => String(value ?? '').trim() !== '');
          if (!hasValue) {
            return;
          }
          const record = {
            id: '',
            name: '',
            title: '',
            manager: '',
            email: '',
            division: '',
            location: '',
            tier: null,
            tierLabel: '',
            status: '',
            completed: null,
            phone: '',
            extras: {},
            tops: []
          };

          entries.forEach(([header, rawValue]) => {
            const value = normaliseValue(rawValue);
            if (value === '') {
              return;
            }
            const key = normaliseHeader(header);
            if (KEY_ALIASES.id.includes(key) && !record.id) {
              record.id = value;
              return;
            }
            if (KEY_ALIASES.name.includes(key) && !record.name) {
              record.name = value;
              return;
            }
            if (KEY_ALIASES.title.includes(key) && !record.title) {
              record.title = value;
              return;
            }
            if (KEY_ALIASES.manager.includes(key) && !record.manager) {
              record.manager = value;
              return;
            }
            if (KEY_ALIASES.email.includes(key) && !record.email) {
              record.email = value;
              return;
            }
            if (KEY_ALIASES.division.includes(key) && !record.division) {
              record.division = value;
              return;
            }
            if (KEY_ALIASES.location.includes(key) && !record.location) {
              record.location = value;
              return;
            }
            if (KEY_ALIASES.phone.includes(key) && !record.phone) {
              record.phone = value;
              return;
            }
            if (KEY_ALIASES.tier.includes(key)) {
              const numericTier = parseFloat(value);
              if (!Number.isNaN(numericTier)) {
                record.tier = numericTier;
              } else {
                record.tierLabel = value;
              }
              return;
            }
            if (KEY_ALIASES.status.includes(key) && !record.status) {
              record.status = value;
              const normalized = value.toLowerCase();
              if (/^(y|yes|completed|done|true|complete)/.test(normalized)) {
                record.completed = true;
              } else if (/^(n|no|false|pending|not)/.test(normalized)) {
                record.completed = false;
              }
              return;
            }
            const strengthMatch = key.match(strengthRegex);
            if (strengthMatch) {
              const rank = parseInt(strengthMatch[2], 10);
              if (!Number.isNaN(rank) && rank > 0) {
                record.tops[rank - 1] = value;
              } else {
                record.tops.push(value);
              }
              return;
            }
            record.extras[header] = value;
          });

          if (!record.name && !record.title && !record.id) {
            return;
          }

          if (!record.id) {
            const base = record.name ? record.name.replace(/[^a-zA-Z0-9]+/g, '-').replace(/^-+|-+$/g, '').toLowerCase() : 'person';
            let candidate = base || `person-${index + 1}`;
            let counter = 1;
            while (usedIds.has(candidate)) {
              counter += 1;
              candidate = `${base || 'person'}-${counter}`;
            }
            record.id = candidate;
          }

          if (usedIds.has(record.id)) {
            let counter = 2;
            let candidate = `${record.id}-${counter}`;
            while (usedIds.has(candidate)) {
              counter += 1;
              candidate = `${record.id}-${counter}`;
            }
            record.id = candidate;
          }

          usedIds.add(record.id);
          record.tops = record.tops.filter(Boolean);
          people.push(record);
          record.tops.forEach((strength, idx) => {
            strengths.push({ id: record.id, strength, rank: idx + 1 });
          });
        });

        return { people, strengths };
      }

      function normaliseValue(value) {
        if (value === null || value === undefined) {
          return '';
        }
        if (typeof value === 'number') {
          return String(value);
        }
        return String(value).trim();
      }

      function normaliseHeader(header) {
        return String(header || '').trim().toLowerCase().replace(/[^a-z0-9]+/g, '');
      }

      function buildHierarchy(people) {
        const nodes = people.map(person => ({ ...person, children: [] }));
        const byId = new Map();
        const byIdCondensed = new Map();
        const byName = new Map();
        const parentMap = new Map();

        nodes.forEach(node => {
          byId.set(node.id, node);
          byIdCondensed.set(normaliseIdKey(node.id), node);
          if (node.name) {
            const key = node.name.toLowerCase();
            if (!byName.has(key)) {
              byName.set(key, node);
            }
          }
        });

        nodes.forEach(node => {
          const managerKey = (node.manager || '').trim();
          if (!managerKey) {
            return;
          }
          const parentNode = resolveManager(managerKey, node.id);
          if (parentNode && parentNode !== node) {
            parentNode.children.push(node);
            parentMap.set(node.id, parentNode.id);
          }
        });

        const roots = nodes.filter(node => !parentMap.has(node.id));
        return { roots, fullMap: byId, parentMap };

        function resolveManager(label, childId) {
          if (!label) return null;
          if (byId.has(label)) {
            return byId.get(label);
          }
          const condensed = normaliseIdKey(label);
          if (byIdCondensed.has(condensed)) {
            const candidate = byIdCondensed.get(condensed);
            if (candidate.id !== childId) {
              return candidate;
            }
          }
          const lower = label.toLowerCase();
          if (byName.has(lower)) {
            const candidate = byName.get(lower);
            if (candidate.id !== childId) {
              return candidate;
            }
          }
          return null;
        }
      }

      function normaliseIdKey(value) {
        return String(value || '').replace(/[^a-zA-Z0-9]+/g, '').toLowerCase();
      }

      function populateRootSelector(roots) {
        els.rootSelect.innerHTML = '';
        if (!roots.length) {
          els.rootSelect.disabled = true;
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'No root detected';
          els.rootSelect.appendChild(opt);
          renderChart(null);
          renderDetail(null);
          return;
        }
        els.rootSelect.disabled = false;
        roots.sort((a, b) => {
          const tierA = typeof a.tier === 'number' ? a.tier : Number.MAX_SAFE_INTEGER;
          const tierB = typeof b.tier === 'number' ? b.tier : Number.MAX_SAFE_INTEGER;
          if (tierA !== tierB) return tierA - tierB;
          const sizeA = (a.children || []).length;
          const sizeB = (b.children || []).length;
          if (sizeA !== sizeB) return sizeB - sizeA;
          const nameA = a.name || a.id;
          const nameB = b.name || b.id;
          return nameA.localeCompare(nameB);
        });

        const allOption = document.createElement('option');
        allOption.value = ALL_ROOT_ID;
        allOption.textContent = `${ALL_ROOT_LABEL} (${roots.length})`;
        els.rootSelect.appendChild(allOption);

        roots.forEach(root => {
          const option = document.createElement('option');
          option.value = root.id;
          const parts = [root.name || root.id];
          if (root.title) {
            parts.push(root.title);
          }
          option.textContent = parts.join(' - ');
          els.rootSelect.appendChild(option);
        });

        els.rootSelect.value = ALL_ROOT_ID;
        setActiveRoot(ALL_ROOT_ID);
      }

      function setActiveRoot(id, options = {}) {
        const targetId = id || ALL_ROOT_ID;
        if (targetId !== ALL_ROOT_ID && !state.fullById.has(targetId)) {
          return;
        }
        state.activeRootId = targetId;
        if (els.rootSelect && els.rootSelect.value !== targetId) {
          els.rootSelect.value = targetId;
        }
        const rootData = buildRootData(targetId);
        if (!rootData) {
          return;
        }
        const preserveSelection = options.preserveSelection === true;
        const previousSelection = preserveSelection ? state.selectedId : null;
        renderChart(rootData, () => {
          if (previousSelection && state.nodeById.has(previousSelection)) {
            setActiveNode(state.nodeById.get(previousSelection), { focus: false });
          } else if (targetId !== ALL_ROOT_ID) {
            const rootNode = state.nodeById.get(targetId);
            if (rootNode) {
              setActiveNode(rootNode, { focus: false });
            } else {
              renderDetail(null);
            }
          } else {
            state.selectedId = null;
            renderDetail(null);
            updateHighlights();
          }
          fitChart();
        });
      }

      function setOrientation(value) {
        const next = value === 'horizontal' ? 'horizontal' : 'vertical';
        if (next === state.orientation) {
          return;
        }
        state.orientation = next;
        treeLayout = createTreeLayout(next);
        connector = createConnector(next);
        if (els.layoutSelect && els.layoutSelect.value !== next) {
          els.layoutSelect.value = next;
        }
        if (d3Root) {
          update(d3Root);
          fitChart();
        }
      }

      function buildRootData(id) {
        if (id === ALL_ROOT_ID) {
          const children = state.roots.map(root => cloneTree(root)).filter(Boolean);
          return {
            id: ALL_ROOT_ID,
            name: ALL_ROOT_LABEL,
            title: '',
            children
          };
        }
        const source = state.fullById.get(id);
        if (!source) {
          return null;
        }
        return cloneTree(source);
      }

      function cloneTree(obj) {
        if (!obj) {
          return null;
        }
        try {
          if (typeof structuredClone === 'function') {
            return structuredClone(obj);
          }
        } catch (error) {
          console.warn('structuredClone failed, falling back to JSON', error);
        }
        return JSON.parse(JSON.stringify(obj));
      }

      function renderChart(data, onReady) {
        els.chart.innerHTML = '';
        hideTooltip();
        state.nodeById = new Map();

        if (!data) {
          svg = null;
          gRoot = null;
          gLinks = null;
          gNodes = null;
          d3Root = null;
          return;
        }

        const width = els.chart.clientWidth || 800;
        const height = els.chart.clientHeight || 600;

        svg = d3.select(els.chart).append('svg')
          .attr('width', width)
          .attr('height', height)
          .attr('viewBox', `0 0 ${width} ${height}`);

        gRoot = svg.append('g');
        gLinks = gRoot.append('g').attr('class', 'links');
        gNodes = gRoot.append('g').attr('class', 'nodes');

        zoomBehavior = d3.zoom()
          .scaleExtent([0.3, 2.4])
          .on('zoom', event => {
            gRoot.attr('transform', event.transform);
          });

        svg.call(zoomBehavior);

        d3Root = d3.hierarchy(data, d => d.children);
        d3Root.x0 = height / 2;
        d3Root.y0 = 0;

        collapseBeyondDepth(d3Root, 2);
        update(d3Root);

        requestAnimationFrame(() => {
          fitChart();
          if (typeof onReady === 'function') {
            onReady();
          }
        });
      }

      function collapseBeyondDepth(node, depthLimit) {
        if (!node.children) {
          return;
        }
        node.children.forEach(child => collapseBeyondDepth(child, depthLimit));
        if (node.depth >= depthLimit) {
          node._children = node.children;
          node.children = null;
        }
      }

      function update(source) {
        if (!d3Root || !svg) {
          return;
        }

        treeLayout(d3Root);
        const nodes = d3Root.descendants();
        const links = d3Root.links();
        state.nodeById = new Map(nodes.map(node => [node.data.id, node]));

        const origin = { x: source.x0 ?? source.x ?? 0, y: source.y0 ?? source.y ?? 0 };
        const originProjected = projectCoordinates(origin.x, origin.y);
        const isVertical = state.orientation === 'vertical';
        const toggleTransform = isVertical ? `translate(0,${CONFIG.nodeHeight / 2 + 12})` : `translate(${CONFIG.nodeWidth / 2 - 14},0)`;
        const transition = svg.transition().duration(320);

        const nodeSelection = gNodes.selectAll('g.node')
          .data(nodes, d => d.data.id);

        const nodeEnter = nodeSelection.enter().append('g')
          .attr('class', 'node')
          .attr('transform', `translate(${originProjected.py},${originProjected.px})`)
          .on('click', (event, d) => {
            setActiveNode(d, { focus: false });
          })
          .on('mouseenter', (event, d) => showTooltip(event, d))
          .on('mousemove', (event, d) => showTooltip(event, d))
          .on('mouseleave', hideTooltip);

        nodeEnter.append('rect')
          .attr('class', 'node-card')
          .attr('x', -CONFIG.nodeWidth / 2)
          .attr('y', -CONFIG.nodeHeight / 2)
          .attr('width', CONFIG.nodeWidth)
          .attr('height', CONFIG.nodeHeight)
          .attr('rx', 16)
          .attr('ry', 16);

        const foreign = nodeEnter.append('foreignObject')
          .attr('class', 'node-fo')
          .attr('x', -CONFIG.nodeWidth / 2 + 14)
          .attr('y', -CONFIG.nodeHeight / 2 + 12)
          .attr('width', CONFIG.nodeWidth - 28)
          .attr('height', CONFIG.nodeHeight - 24);

        foreign.append('xhtml:div')
          .attr('class', 'node-content')
          .html(d => renderNodeHtml(d.data));

        const toggle = nodeEnter.append('g')
          .attr('class', 'node-toggle')
          .attr('transform', toggleTransform)
          .on('click', (event, d) => {
            event.stopPropagation();
            toggleBranch(d);
          });

        toggle.append('circle')
          .attr('class', 'toggle-circle')
          .attr('r', 10);

        toggle.append('line')
          .attr('class', 'toggle-line vertical')
          .attr('x1', -5)
          .attr('x2', 5)
          .attr('y1', 0)
          .attr('y2', 0);

        toggle.append('line')
          .attr('class', 'toggle-line horizontal')
          .attr('x1', 0)
          .attr('x2', 0)
          .attr('y1', -5)
          .attr('y2', 5);

        const nodeMerge = nodeEnter.merge(nodeSelection);

        nodeMerge.select('.node-content')
          .html(d => renderNodeHtml(d.data));

        nodeMerge.select('.node-toggle')
          .style('display', d => hasChildren(d) ? 'flex' : 'none')
          .attr('transform', toggleTransform)
          .classed('collapsed', d => !!d._children)
          .classed('toggle-bottom', isVertical);

        nodeMerge.select('.node-toggle .vertical')
          .style('opacity', d => d._children ? 1 : 0);

        nodeMerge.classed('root', d => d.depth === 0);

        nodeMerge.transition(transition)
          .attr('transform', d => {
            const projected = projectCoordinates(d.x, d.y);
            return `translate(${projected.py},${projected.px})`;
          });

        nodeSelection.exit().transition(transition)
          .attr('transform', `translate(${originProjected.py},${originProjected.px})`)
          .remove();

        const linkSelection = gLinks.selectAll('path.link')
          .data(links, d => d.target.data.id);

        linkSelection.enter().append('path')
          .attr('class', 'link')
          .attr('d', () => connector({ source: origin, target: origin }))
          .merge(linkSelection)
          .transition(transition)
          .attr('d', d => {
            const offset = isVertical ? CONFIG.nodeHeight / 2 : CONFIG.nodeWidth / 2;
            return connector({
              source: { x: d.source.x, y: d.source.y + offset },
              target: { x: d.target.x, y: d.target.y - offset }
            });
          });

        linkSelection.exit()
          .transition(transition)
          .attr('d', () => connector({ source: origin, target: origin }))
          .remove();

        nodes.forEach(node => {
          node.x0 = node.x;
          node.y0 = node.y;
        });

        updateHighlights();
      }

      function hasChildren(node) {
        return (node.children && node.children.length) || (node._children && node._children.length);
      }

      function toggleBranch(node) {
        if (node.children) {
          node._children = node.children;
          node.children = null;
        } else if (node._children) {
          node.children = node._children;
          node._children = null;
        }
        update(node);
      }

      function setActiveNode(node, options = { focus: false }) {
        if (!node) {
          state.selectedId = null;
          updateHighlights();
          renderDetail(null);
          return;
        }
        if (state.detailTab !== 'profile') {
          setDetailTab('profile');
        }
        state.selectedId = node.data.id;
        updateHighlights();
        renderDetail(node);
        if (options.focus) {
          centerOnNode(node);
        }
      }

      function updateHighlights() {
        if (!gNodes || !gLinks) {
          return;
        }
        const activeNodes = new Set();
        const activeLinks = new Set();
        if (state.selectedId && state.nodeById.has(state.selectedId)) {
          let cursor = state.nodeById.get(state.selectedId);
          while (cursor) {
            activeNodes.add(cursor.data.id);
            if (cursor.parent) {
              activeLinks.add(`${cursor.parent.data.id}->${cursor.data.id}`);
            }
            cursor = cursor.parent;
          }
        }
        const strengthMatches = new Set();
        if (state.strengthHighlight) {
          state.nodeById.forEach(node => {
            if (nodeHasStrength(node, state.strengthHighlight)) {
              strengthMatches.add(node.data.id);
            }
          });
        }
        gNodes.selectAll('g.node')
          .classed('is-on-path', d => activeNodes.has(d.data.id))
          .classed('is-selected', d => d.data.id === state.selectedId)
          .classed('has-strength-match', d => strengthMatches.has(d.data.id));

        gNodes.selectAll('rect.node-card')
          .classed('is-on-path', d => activeNodes.has(d.data.id))
          .classed('is-selected', d => d.data.id === state.selectedId)
          .classed('is-strength-match', d => strengthMatches.has(d.data.id));

        gLinks.selectAll('path.link')
          .classed('is-on-path', d => activeLinks.has(`${d.source.data.id}->${d.target.data.id}`));
      }

      function centerOnNode(node) {
        if (!svg || !zoomBehavior) {
          return;
        }
        const width = els.chart.clientWidth || 800;
        const height = els.chart.clientHeight || 600;
        const padding = 120;
        const scale = Math.min(1.25, Math.max(0.6, Math.min(width / (CONFIG.nodeWidth + padding), height / (CONFIG.nodeHeight + padding))));
        const translateX = state.orientation === 'vertical' ? -node.x : -node.y;
        const translateY = state.orientation === 'vertical' ? -node.y : -node.x;
        const transform = d3.zoomIdentity
          .translate(width / 2, height / 2)
          .scale(scale)
          .translate(translateX, translateY);
        svg.transition().duration(420).call(zoomBehavior.transform, transform);
      }

      function fitChart() {
        if (!svg || !gRoot) {
          return;
        }
        const bbox = gRoot.node().getBBox();
        if (!bbox || !bbox.width || !bbox.height) {
          return;
        }
        const width = els.chart.clientWidth || 800;
        const height = els.chart.clientHeight || 600;
        const paddingBase = Math.min(width, height) * 0.12;
        const padding = Math.max(40, Math.min(90, paddingBase));
        const scale = Math.min(
          2,
          Math.max(
            0.3,
            Math.min(
              (width - padding) / bbox.width,
              (height - padding) / bbox.height
            )
          )
        );
        const transform = d3.zoomIdentity
          .translate(width / 2 - (bbox.x + bbox.width / 2) * scale, height / 2 - (bbox.y + bbox.height / 2) * scale)
          .scale(scale);
        svg.transition().duration(420).call(zoomBehavior.transform, transform);
      }

      function expandAll() {
        if (!d3Root) {
          return;
        }
        d3Root.each(node => {
          if (node._children) {
            node.children = node._children;
            node._children = null;
          }
        });
        update(d3Root);
        if (state.selectedId && state.nodeById.has(state.selectedId)) {
          centerOnNode(state.nodeById.get(state.selectedId));
        }
      }

      function collapseAll() {
        if (!d3Root) {
          return;
        }
        d3Root.each(node => {
          if (node.children && node.depth > 0) {
            node._children = node.children;
            node.children = null;
          }
        });
        update(d3Root);
        if (state.activeRootId && state.nodeById.has(state.activeRootId) && state.activeRootId !== ALL_ROOT_ID) {
          setActiveNode(state.nodeById.get(state.activeRootId), { focus: false });
        } else {
          state.selectedId = null;
          renderDetail(null);
          updateHighlights();
        }
        fitChart();
      }

      function resetView() {
        if (!state.activeRootId) {
          return;
        }
        setActiveRoot(state.activeRootId);
      }

      function handleResize() {
        if (!svg) {
          return;
        }
        const width = els.chart.clientWidth || 800;
        const height = els.chart.clientHeight || 600;
        svg.attr('width', width).attr('height', height).attr('viewBox', `0 0 ${width} ${height}`);
        fitChart();
      }

      function renderTrendPanel() {
        if (!els.trendBody) {
          return;
        }
        if (!state.people.length) {
          els.trendBody.innerHTML = `<div class="trend-empty">
            <h3>No data loaded</h3>
            <p>Upload a workbook to explore team strengths.</p>
          </div>`;
          return;
        }
        if (!state.strengthSummary.length) {
          els.trendBody.innerHTML = `<div class="trend-empty">
            <h3>No strengths captured</h3>
            <p>Add top strengths to your dataset to see trends here.</p>
          </div>`;
          return;
        }
        const sortState = state.strengthSort || { field: 'count', direction: 'desc' };
        const highlight = state.strengthHighlight;
        const summaryCards = [
          `<div class="summary-card"><div class="summary-value">${state.people.length}</div><div class="summary-label">People</div></div>`,
          `<div class="summary-card"><div class="summary-value">${state.strengthSummary.length}</div><div class="summary-label">Unique strengths</div></div>`
        ];
        const sortedSummary = state.strengthSummary.slice().sort((a, b) => {
          if (sortState.field === 'avgRank') {
            const diff = a.avgRank - b.avgRank;
            if (diff !== 0) {
              return sortState.direction === 'asc' ? diff : -diff;
            }
            if (a.count !== b.count) {
              return sortState.direction === 'asc' ? b.count - a.count : a.count - b.count;
            }
            return a.name.localeCompare(b.name);
          }
          const diff = a.count - b.count;
          if (diff !== 0) {
            return sortState.direction === 'asc' ? diff : -diff;
          }
          if (a.avgRank !== b.avgRank) {
            return a.avgRank - b.avgRank;
          }
          return a.name.localeCompare(b.name);
        });
        const isCountSort = sortState.field === 'count';
        const isRankSort = sortState.field === 'avgRank';
        const countSymbol = isCountSort
          ? (sortState.direction === 'desc' ? '&darr;' : '&uarr;')
          : '&darr;';
        const rankSymbol = isRankSort
          ? (sortState.direction === 'desc' ? '&darr;' : '&uarr;')
          : '&uarr;';
        const sortControls = `
          <div class="trend-controls">
            <span class="trend-controls-label">Sort by</span>
            <div class="trend-controls-buttons">
              <button type="button" class="trend-sort-btn${isCountSort ? ' is-active' : ''}" data-sort-field="count">
                <span>People</span>
                <span class="trend-sort-icon">${countSymbol}</span>
              </button>
              <button type="button" class="trend-sort-btn${isRankSort ? ' is-active' : ''}" data-sort-field="avgRank">
                <span>Avg rank</span>
                <span class="trend-sort-icon">${rankSymbol}</span>
              </button>
            </div>
          </div>
        `;
        const listItems = sortedSummary.map(entry => {
          const percent = entry.percent.toFixed(0);
          const avg = entry.avgRank.toFixed(1);
          const activeClass = highlight === entry.key ? ' is-active' : '';
          return `
            <button type="button" class="trend-item${activeClass}" data-strength-key="${escapeHtml(entry.key)}">
              <span class="trend-name">${escapeHtml(entry.name)}</span>
              <div class="trend-meta">
                <span class="trend-count"><strong>${entry.count}</strong> people &middot; ${percent}%</span>
                <span class="trend-rank">Avg rank ${avg}</span>
              </div>
            </button>
          `;
        }).join('');
        els.trendBody.innerHTML = `
          <div class="trend-summary">
            ${summaryCards.join('')}
          </div>
          ${sortControls}
          <div class="trend-list">
            ${listItems}
          </div>
        `;
        Array.from(els.trendBody.querySelectorAll('.trend-item')).forEach(button => {
          button.addEventListener('click', () => {
            const key = button.getAttribute('data-strength-key');
            setStrengthHighlight(key);
          });
        });
        Array.from(els.trendBody.querySelectorAll('.trend-sort-btn')).forEach(button => {
          button.addEventListener('click', () => {
            const field = button.getAttribute('data-sort-field');
            if (field) {
              setStrengthSort(field);
            }
          });
        });
      }

      function setStrengthHighlight(rawKey) {
        const normalised = normaliseStrength(rawKey);
        const next = normalised && state.strengthHighlight === normalised ? null : normalised;
        state.strengthHighlight = next;
        renderTrendPanel();
        updateHighlights();
        if (state.selectedId && state.nodeById.has(state.selectedId)) {
          renderDetail(state.nodeById.get(state.selectedId));
        }
      }

      function setStrengthSort(field) {
        if (!field) {
          return;
        }
        const current = state.strengthSort || { field: 'count', direction: 'desc' };
        let direction;
        if (current.field === field) {
          direction = current.direction === 'desc' ? 'asc' : 'desc';
        } else {
          direction = field === 'avgRank' ? 'asc' : 'desc';
        }
        state.strengthSort = { field, direction };
        renderTrendPanel();
      }

      function computeStrengthSummary() {
        const summaryMap = new Map();
        const totalPeople = state.people.length || 0;
        state.people.forEach(person => {
          const tops = Array.isArray(person.tops) ? person.tops : [];
          tops.forEach((strength, index) => {
            const name = String(strength ?? '').trim();
            if (!name) {
              return;
            }
            const key = normaliseStrength(name);
            if (!key) {
              return;
            }
            if (!summaryMap.has(key)) {
              summaryMap.set(key, { key, name, count: 0, totalRank: 0, bestRank: Number.MAX_SAFE_INTEGER });
            }
            const entry = summaryMap.get(key);
            if (!entry.name && name) {
              entry.name = name;
            }
            entry.count += 1;
            entry.totalRank += index + 1;
            if (index + 1 < entry.bestRank) {
              entry.bestRank = index + 1;
            }
          });
        });
        state.strengthSummary = Array.from(summaryMap.values()).map(entry => ({
          key: entry.key,
          name: entry.name,
          count: entry.count,
          avgRank: entry.count ? entry.totalRank / entry.count : 0,
          bestRank: entry.bestRank === Number.MAX_SAFE_INTEGER ? null : entry.bestRank,
          percent: totalPeople ? (entry.count / totalPeople) * 100 : 0
        })).sort((a, b) => {
          if (b.count !== a.count) return b.count - a.count;
          if (a.avgRank !== b.avgRank) return a.avgRank - b.avgRank;
          return a.name.localeCompare(b.name);
        });
      }

      function normaliseStrength(value) {
        return String(value ?? '').trim().toLowerCase();
      }

      function getStrengthLabel(key) {
        const entry = state.strengthSummary.find(item => item.key === key);
        return entry ? entry.name : (key || '');
      }

      function setDetailTab(tab) {
        const next = tab === 'strengths' ? 'strengths' : 'profile';
        if (next === state.detailTab) {
          return;
        }
        state.detailTab = next;
        updateDetailTabUi();
        if (next === 'strengths') {
          renderTrendPanel();
        }
      }

      function updateDetailTabUi() {
        if (els.profileBody) {
          els.profileBody.classList.toggle('detail-body--hidden', state.detailTab !== 'profile');
        }
        if (els.trendBody) {
          els.trendBody.classList.toggle('detail-body--hidden', state.detailTab !== 'strengths');
        }
        if (els.detailTabs) {
          Array.from(els.detailTabs.querySelectorAll('.detail-tab')).forEach(button => {
            const tabName = button.getAttribute('data-tab');
            const isActive = tabName === state.detailTab;
            button.classList.toggle('is-active', isActive);
            button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
          });
        }
      }

      function onDetailTabClick(event) {
        const button = event.target.closest('.detail-tab');
        if (!button) {
          return;
        }
        const tab = button.getAttribute('data-tab');
        if (!tab) {
          return;
        }
        setDetailTab(tab);
      }

      function renderNodeHtml(person) {
        const name = escapeHtml(person.name || person.id || 'Unnamed person');
        const title = person.title ? `<div class="node-title">${escapeHtml(person.title)}</div>` : '';
        const metaParts = [];
        if (person.division) metaParts.push(escapeHtml(person.division));
        if (person.location) metaParts.push(escapeHtml(person.location));
        const meta = metaParts.length ? `<div class="node-meta">${metaParts.join('  ')}</div>` : '';
        const chips = [];
        const tierClass = getTierChipClass(person.tier ?? person.tierLabel);
        if (typeof person.tier === 'number' && !Number.isNaN(person.tier)) {
          const tierValue = escapeHtml(String(person.tier));
          const classAttr = tierClass ? `chip ${tierClass}` : 'chip';
          chips.push(`<span class="${classAttr}">Tier ${tierValue}</span>`);
        } else if (person.tierLabel) {
          const tierValue = escapeHtml(person.tierLabel);
          const classAttr = tierClass ? `chip ${tierClass}` : 'chip';
          chips.push(`<span class="${classAttr}">Tier ${tierValue}</span>`);
        }
        const fullNode = state.fullById.get(person.id);
        const directReports = fullNode && Array.isArray(fullNode.children) ? fullNode.children.length : (person.children ? person.children.length : 0);
        if (directReports) {
          chips.push(`<span class="chip chip-soft">Direct Rpt: ${directReports}</span>`);
        }
        const chipsMarkup = chips.length ? `<div class="node-chips">${chips.join('')}</div>` : '';
        return `
          <div class="node-name">${name}</div>
          ${title}
          ${meta}
          ${chipsMarkup}
        `;
      }

      function getTierChipClass(value) {
        const match = String(value ?? "").match(/\d+/);
        if (!match) {
          return "";
        }
        const numeric = parseInt(match[0], 10);
        if (!Number.isFinite(numeric) || numeric < 1) {
          return "";
        }
        const capped = Math.min(numeric, 6);
        return `chip-tier-${capped}`;
      }

      function renderDetail(node) {
        if (!els.profileBody) {
          return;
        }
        if (!node) {
          els.profileBody.innerHTML = `<div class="detail-empty">
            <h2>No person selected</h2>
            <p>Select a card to view profile details or open the Strength Trends tab for team insights.</p>
          </div>`;
          return;
        }
        const person = state.fullById.get(node.data.id) || node.data;
        const managerId = state.parentById.get(person.id);
        const manager = managerId ? state.fullById.get(managerId) : null;
        const directReports = person.children ? person.children.length : 0;
        const teamSize = countTeamSize(person);
        const breadcrumbs = [];
        let cursor = node;
        while (cursor) {
          breadcrumbs.unshift(cursor.data);
          cursor = cursor.parent;
        }
        const breadcrumbHtml = breadcrumbs.map((p, index) => {
          const label = escapeHtml(p.name || p.id);
          return `<span class="crumb${index === breadcrumbs.length - 1 ? ' current' : ''}">${label}</span>`;
        }).join('<span class="crumb-divider">-></span>');

        const topStrengths = Array.isArray(person.tops)
          ? person.tops.map((strength, index) => {
              const name = String(strength ?? '').trim();
              if (!name) {
                return null;
              }
              return {
                name,
                rank: index + 1,
                key: normaliseStrength(name)
              };
            }).filter(Boolean).slice(0, 10)
            .sort((a, b) => a.rank - b.rank)
          : [];
        const activeStrengthKey = state.strengthHighlight;
        const activeStrengthEntry = activeStrengthKey && topStrengths.some(item => item.key === activeStrengthKey)
          ? state.strengthSummary.find(entry => entry.key === activeStrengthKey) || null
          : null;
        const strengthStats = activeStrengthEntry
          ? `<div class="strength-insight">
              <div class="strength-insight-title">${escapeHtml(activeStrengthEntry.name)}</div>
              <div class="strength-insight-metrics">
                <span><strong>${activeStrengthEntry.count}</strong> people</span>
                <span>${activeStrengthEntry.percent.toFixed(0)}%</span>
                <span>Avg rank ${activeStrengthEntry.avgRank.toFixed(1)}</span>
              </div>
            </div>`
          : '';
        const strengthList = topStrengths.length
          ? `<div class="detail-section">
              <div class="section-title">Top strengths</div>
              <div class="chip-row">${topStrengths.map(item => {
                const activeClass = state.strengthHighlight === item.key ? ' is-active' : '';
                return `<button type="button" class="chip chip-soft strength-chip${activeClass}" data-strength-key="${escapeHtml(item.key)}">
                  <span class="strength-chip-label">
                    <span class="strength-chip-rank">Top ${item.rank}</span>
                    <span>${escapeHtml(item.name)}</span>
                  </span>
                </button>`;
              }).join('')}</div>
              ${strengthStats}
            </div>`
          : '';

        const infoItems = [];
        if (person.email) {
          infoItems.push(`<div><span class="label">Email</span><a class="value value-link" href="mailto:${encodeURIComponent(person.email)}">${escapeHtml(person.email)}</a></div>`);
        }
        if (person.phone) {
          infoItems.push(`<div><span class="label">Phone</span><span class="value">${escapeHtml(person.phone)}</span></div>`);
        }
        if (person.division) {
          infoItems.push(`<div><span class="label">Division</span><span class="value">${escapeHtml(person.division)}</span></div>`);
        }
        if (person.location) {
          infoItems.push(`<div><span class="label">Location</span><span class="value">${escapeHtml(person.location)}</span></div>`);
        }
        if (manager) {
          infoItems.push(`<div><span class="label">Manager</span><span class="value">${escapeHtml(manager.name || manager.id)}</span></div>`);
        }
        if (typeof person.tier === 'number' && !Number.isNaN(person.tier)) {
          infoItems.push(`<div><span class="label">Tier</span><span class="value">${escapeHtml(String(person.tier))}</span></div>`);
        } else if (person.tierLabel) {
          infoItems.push(`<div><span class="label">Tier</span><span class="value">${escapeHtml(person.tierLabel)}</span></div>`);
        }
        infoItems.push(`<div><span class="label">Direct reports</span><span class="value">${directReports}</span></div>`);
        infoItems.push(`<div><span class="label">Total team</span><span class="value">${teamSize}</span></div>`);

        const extraEntries = Object.entries(person.extras || {}).slice(0, 6)
          .map(([key, value]) => `<div><span class="label">${escapeHtml(key)}</span><span class="value">${escapeHtml(value)}</span></div>`)
          .join('');
        const extrasBlock = extraEntries ? `<div class="detail-section">
          <div class="section-title">Additional fields</div>
          <div class="info-grid">${extraEntries}</div>
        </div>` : '';

        els.profileBody.innerHTML = `
          <div class="detail-header">
            <div class="detail-name">${escapeHtml(person.name || person.id)}</div>
            ${person.title ? `<div class="detail-title">${escapeHtml(person.title)}</div>` : ''}
            <div class="crumbs">${breadcrumbHtml}</div>
          </div>
          <div class="detail-section">
            <div class="section-title">Snapshot</div>
            <div class="info-grid">
              ${infoItems.join('')}
            </div>
          </div>
          ${strengthList}
          ${extrasBlock}
        `;
        if (topStrengths.length) {
          Array.from(els.profileBody.querySelectorAll('.strength-chip')).forEach(button => {
            button.addEventListener('click', () => {
              const key = button.getAttribute('data-strength-key');
              if (key) {
                setStrengthHighlight(key);
              }
            });
          });
        }
      }

      function countTeamSize(person) {
        let total = 0;
        (function walk(node) {
          if (!node || !node.children) return;
          node.children.forEach(child => {
            total += 1;
            walk(child);
          });
        })(person);
        return total;
      }

      function onSearchInput() {
        const query = els.searchInput.value.trim().toLowerCase();
        if (!query) {
          hideSearchResults();
          return;
        }
        const matches = state.people.filter(person => {
          return ['name', 'title', 'email', 'division', 'location'].some(key => {
            const value = person[key];
            return value && value.toLowerCase().includes(query);
          });
        }).slice(0, 12);

        if (!matches.length) {
          els.searchResults.innerHTML = `<div class="search-empty">No matches found</div>`;
          els.searchResults.classList.add('open');
          return;
        }

        els.searchResults.innerHTML = matches.map(person => `
          <button type="button" class="search-item" data-id="${escapeHtml(person.id)}">
            <span class="search-name">${escapeHtml(person.name || person.id)}</span>
            ${person.title ? `<span class="search-title">${escapeHtml(person.title)}</span>` : ''}
          </button>
        `).join('');

        Array.from(els.searchResults.querySelectorAll('.search-item')).forEach(button => {
          button.addEventListener('click', () => {
            const id = button.getAttribute('data-id');
            focusNodeById(id);
            hideSearchResults();
          });
        });

        els.searchResults.classList.add('open');
      }

      function onSearchKeyDown(event) {
        if (event.key === 'Enter') {
          const button = els.searchResults.querySelector('.search-item');
          if (button) {
            focusNodeById(button.getAttribute('data-id'));
            hideSearchResults();
            els.searchInput.blur();
          }
        }
      }

      function hideSearchResults() {
        els.searchResults.classList.remove('open');
        els.searchResults.innerHTML = '';
      }

      function focusNodeById(id) {
        if (!id) return;
        if (!ensureNodeIsVisible(id)) {
          showMessage('Switch the root leader to view this person\'s team.', 'warn');
          return;
        }
        const node = state.nodeById.get(id);
        if (node) {
          setActiveNode(node, { focus: true });
        }
      }

      function ensureNodeIsVisible(id) {
        if (!d3Root) return false;
        if (state.activeRootId === ALL_ROOT_ID) return true;
        if (id === state.activeRootId) return true;
        let current = id;
        const ancestors = [];
        let belongsToRoot = current === state.activeRootId;
        const seen = new Set();
        while (state.parentById.has(current) && !seen.has(current)) {
          seen.add(current);
          const parentId = state.parentById.get(current);
          ancestors.unshift(parentId);
          if (parentId === state.activeRootId) {
            belongsToRoot = true;
            break;
          }
          current = parentId;
        }
        if (state.activeRootId && !belongsToRoot) {
          return false;
        }
        ancestors.forEach(parentId => {
          const node = state.nodeById.get(parentId);
          if (node && node._children) {
            node.children = node._children;
            node._children = null;
          }
        });
        update(d3Root);
        return true;
      }

      function showTooltip(event, node) {
        if (!els.tooltip) {
          return;
        }
        const person = node.data;
        const parts = [`<div class="tooltip-name">${escapeHtml(person.name || person.id)}</div>`];
        if (person.title) {
          parts.push(`<div class="tooltip-title">${escapeHtml(person.title)}</div>`);
        }
        const meta = [];
        if (person.division) meta.push(escapeHtml(person.division));
        if (person.location) meta.push(escapeHtml(person.location));
        if (meta.length) {
          parts.push(`<div class="tooltip-meta">${meta.join('  ')}</div>`);
        }
        els.tooltip.innerHTML = parts.join('');
        const rect = els.chart.getBoundingClientRect();
        const x = event.clientX - rect.left + 14;
        let y = event.clientY - rect.top - 34;
        if (y < 0) y = 0;
        els.tooltip.style.transform = `translate(${x}px, ${y}px)`;
        els.tooltip.classList.add('visible');
      }

      function hideTooltip() {
        if (els.tooltip) {
          els.tooltip.classList.remove('visible');
        }
      }

      function updateDatasetLabel() {
        if (els.datasetLabel) {
          els.datasetLabel.textContent = state.datasetName || 'Dataset';
        }
      }

      function showMessage(text, tone = 'info', autoDismiss = false) {
        if (!els.banner) {
          return;
        }
        if (bannerTimeout) {
          clearTimeout(bannerTimeout);
          bannerTimeout = null;
        }
        els.banner.textContent = text;
        els.banner.className = `banner banner--${tone}`;
        if (autoDismiss) {
          bannerTimeout = setTimeout(() => hideMessage(), 3600);
        }
      }

      function hideMessage() {
        if (!els.banner) {
          return;
        }
        if (bannerTimeout) {
          clearTimeout(bannerTimeout);
          bannerTimeout = null;
        }
        els.banner.className = 'banner banner--hidden';
      }

      function nodeHasStrength(node, key) {
        if (!key || !node || !node.data) {
          return false;
        }
        const tops = Array.isArray(node.data.tops) ? node.data.tops : [];
        return tops.some(str => normaliseStrength(str) === key);
      }

      function escapeHtml(value) {
        return String(value ?? '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

    })();
  </script>
</body>
</html>